>  To see a world in a grain of sand
And a heaven in a wild flower
Hold infinity in the palm of your hand
And eternity in an hour

　　　　　　　　　　-William Blake

上面这首诗出自英国著名浪漫主义诗人威廉-布雷克。在“机器学习”、“计算机视觉”等概念被炒得火热的“人工智能时代”，我们民生科技人能从某一技术热点切入，将新技术带入到金融应用场景中，做到“以管窥豹，可见一斑”也是极好的了。这里我就从基于机器学习的OCR技术说开去，简单讲一下怎么能让电脑识别出银行票据上的数字，也算是抛砖引玉吧！
# 背景介绍
OCR（Optical Character Recognition，光学字符识别）技术顾名思义，就是让电脑通过光学设备（扫描仪、照相机等）识别出纸质载体上面的文字。在银行业，对传统的业务进行自动化处理，有助于满足人们对更加安全、便捷、高效的银行服务的需求，而利用OCR技术进行银行票据的数字识别，正是业务自动化处理的一个重要环节。接下来，本文将介绍如何对银行承兑汇票右上角的两行编号数字进行识别。
![银行承兑汇票.jpg](http://ouzjv2e18.bkt.clouddn.com/%E9%93%B6%E8%A1%8C%E6%89%BF%E5%85%91%E6%B1%87%E7%A5%A8.jpg)
# 技术路线
对于本任务，我采用这样一种思路：先让机器知道识别哪里，然后在确定怎么识别，最后看下识别效果。因此，技术路线如下：首先进行图片处理，获得我们的感兴趣区域（Region of Interest，ROI）,也就是汇票右上角的两行编号区域；然后进行机器学习模型的训练，训练出一个0~9数字的分类器；最后利用这个分类器进行数字的识别预测，展示结果。工程实现主要利用python+opencv+sklearn，其中opencv库主要负责图片的处理，sklearn库主要负责机器学习模型的搭建。
## 图片处理
机器学习领域有句话，“Garbage in, garbage out.” 就是说输入质量决定输出质量。这和人学习知识是一样的，如果教材都是错的怎么能学好。所以在进行模型训练之前，数据的预处理是十分有必要的。图片处理这一步骤的目的就是获取感兴趣区域，并做去噪处理，为后面模型的训练做准备。
图片处理的流程如下：原始图片->灰度图片->二值图片->膨胀->ROI坐标确定->截取。为了直观理解，我把经过这几步处理后的图片展示出来，如下所示。
![原始图片](http://ouzjv2e18.bkt.clouddn.com/3050005327929238%E6%AD%A3%E9%9D%A2_%E5%89%AF%E6%9C%AC.jpg)
![灰度图片](http://ouzjv2e18.bkt.clouddn.com/3050005327929238_gray_%E5%89%AF%E6%9C%AC.jpg)
![二值图片](http://ouzjv2e18.bkt.clouddn.com/3050005327929238_binary_%E5%89%AF%E6%9C%AC.jpg)
![膨胀](http://ouzjv2e18.bkt.clouddn.com/3050005327929238_dilation_%E5%89%AF%E6%9C%AC.jpg)
![ROI坐标确定](http://ouzjv2e18.bkt.clouddn.com/3050005327929238_dilation_%E5%89%AF%E6%9C%AC2.jpg)
![](http://ouzjv2e18.bkt.clouddn.com/3050005327929238_1_ori.jpg)
![截取](http://ouzjv2e18.bkt.clouddn.com/3050005327929238_0_ori.jpg)
可见，经过以上几步的处理，我们所关注的数字信息区域就呈现出来了。细心的读者可能会问，“这两行数字不就在图像的右上角嘛，用像素坐标来截取不就可以了嘛。”实则不然，因为每张票据在扫描时不可能保证位置的一致性，不同扫描场景录入的图片也会千差万别，因此我们这种自适应的通过图像处理获取ROI的方法是十分有必要的。
接下来就要进行数字的识别了。我们可以看到一串需要识别的数字是8位数，让电脑识别0-9肯定比识别00000000-99999999容易的多，因此我们还要进行单个数字的截取，为后面模型的训练提供数据集。方法与上面类似，这里就不再赘述。最终我随机选取了300个数字样本做训练集，80个数字样本做测试集，示意图如下。
![训练集](http://ouzjv2e18.bkt.clouddn.com/train_%E5%89%AF%E6%9C%AC.png)
![测试集](http://ouzjv2e18.bkt.clouddn.com/test_%E5%89%AF%E6%9C%AC.png)
## 模型训练
对数字、文字的识别实际上是图像识别领域的一个分支。当前最火的深度学习技术，最早就兴起于图像识别领域。一年一度的图像分类比赛ILSVRC（ImageNet Large Scale Visual Recognition Challenge）备受学界和商界的关注，历年的冠军模型如AlexNet、VGG、GoogleNet无一不采用了多层卷积神经网络（CNN）的架构。就像编程界的“Hello World”一样，图像识别领域的“Hello World”就是MNIST数据库的手写数字识别，自己搭建个CNN模型就可以跑出很好的成绩。由于本文的应用场景是印刷体数字的识别，相较手写数字识别会容易很多，没有必要“故弄玄虚”用深度学习的方法，本文采用了具有坚实的数学理论基础的支持向量机（SVM）分类器。
首先来简单介绍下SVM的基本知识。总的来说，SVM是一种解决二分类问题的分类器，它的基本模型定义为特征空间上间隔最大的线性分类器，其学习策略就是间隔最大化。下面举个简单的例子直观理解下。
![二分类示例_训练](http://ouzjv2e18.bkt.clouddn.com/train_clf.png)
我们要对上图中的红点和绿点做分类，横纵坐标分别代表两个特征维度，你是选择分类器A、B还是C呢？我会选择B，因为虽然训练集中分类器A、B和C都能做出准确的分类判断，如上图所示，但是我们在对新样本做分类预测时，B的效果会优于A和C。如下图所示，虚线框住的样本是我们要做分类预测的新样本，只有B做出了准确的划分。利用训练样本，训练出间隔最大化的线性分类器，这就是SVM方法。
![二分类示例_预测](http://ouzjv2e18.bkt.clouddn.com/pre_clf.png)
我们面临的数字识别问题实际上就是一个将数字划分到0-9这10个类的分类问题。相较于上面的例子，更复杂了一些：
1.SVM方法只适用于二分类问题，我们面临的是多分类问题该怎么办呢？
2.上面的例子每个样本有两个特征维度，而我们又怎么确定我们数字图像的特征维度呢？
3.上面的例子是线性可分的，如果线性不可分该怎么办呢？
下面我们来各个击破：
1.利用SVM做多分类问题，可以每两个类之间都训练一个分类器，如果有n个类，就会训练出n(n-1)/2个分类器。对未知样本分类时，依次使用这n(n-1)/2个分类器进行预测，预测进哪个类别的次数最多就作为最终分类结果，这就是“1v1”方法。我使用的sklearn.svm包的svc()方法就是用了这个原理进行多分类的。
2.经过前面介绍的图像预处理过程，我们的数字图像都是固定大小（29 * 41）的二值图像了。因此可以用一个只含有0或1的一维数组来表示，数组的长度就是29*41=1189，而这个1189个0或1的像素即可视为图像的特征维度。由于特征维度过大，容易造成过拟合现象，使模型泛化能力不强，因此我利用了PCA方法（主成分分析法）进行降维，降维标准是使主成分的方差和占比至少90%。为了直观一些，我将特征空间降到了只有3维进行绘图，如下所示。
![特征降维展示](http://ouzjv2e18.bkt.clouddn.com/PCA_3D.png)
3.事实上，绝大部分分类问题都是线性不可分的。对于线性不可分问题，SVM提供了核函数方法，将低维度的线性不可分问题转换为高纬度的线性可分问题。我使用了径向基（RBF）核函数。
至此，我们的SVM模型基本介绍完毕了，剩下的就是喂入数据进行模型的训练和参数的调优了，这里还有些细节部分，就不做介绍了。
## 结果展示
首先是进行单个数字图像的预测。使用的是测试集的80的单个数字图像，所有数字均预测正确，验证了SVM模型的有效性。
接下来是进行原始图片的数字序列预测。对200张银行承兑汇票的原始图片进行图片处理和SVM模型预测，结果只有1张图片预测错误（将“30500053 27933550”预测为了“30500053 27933503”），准确率为99.5%，验证了整个方法流程的可行性。
最后将程序打包发布为exe文件，可做本地化部署。本地其他程序可用HTTP GET/POST方法进行调用。如下图所示。
![GET请求](http://ouzjv2e18.bkt.clouddn.com/deploy.png)
# 小结
本文介绍了一种利用图像处理和机器学习进行银行票据数字识别的方法，虽然只是建立了一个较为简单的原始模型，但是我们能从中看到OCR技术的基本原理和流程，当成科普小文一读轻松加愉快嘛。事实上，其他机器学习、数据挖掘领域的问题也基本走的文中的流程：先进行数据探索和预处理，就像本文的图像处理过程；接着进行特征工程，就像本文利用PCA进行降维增强模型泛化能力；最后进行模型的选择和训练，并最终做出决策。做决策的过程比较流行Ensemble generation方法，就是建立多个base model组合成一个ensemble model，毕竟“三个臭皮匠赛过诸葛亮”嘛。以上就是本文的全部内容啦，希望对您能有所帮助。
